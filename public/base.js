"use strict";function innit(){!function(){var e={};window.tmpl=function t(n,r){var i=/\W/.test(n)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+n.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):e[n]=e[n]||t(document.getElementById(n).innerHTML);return r?i(r):i}}(),CHAT.API.initApp(CHAT.API.servicesList.router)}var CHAT={servicesFunctionality:{},root:{},API:{servicesList:{},pages:[],cashTemplates:{},initPage:function(e){for(var t={loadTemplate:function(e){var t=CHAT.API.cashTemplates[CHAT.API.pages[e].pageInfo.name.replace("-","_")];if(!t){var n=CHAT.API.servicesList.httpAjax().get(CHAT.API.pages[e].pageInfo.template,"GET");return CHAT.API.cashTemplates[CHAT.API.pages[e].pageInfo.name.replace("-","_")]=n,n}return t},renderTemplate:function(e){var t=document.createElement("div");t.innerHTML=e,document.getElementById("body").innerHTML="",document.getElementById("body").appendChild(t),CHAT.API.servicesList.router().linkSettings()},concatService:function(e){for(var t={},n=0;n<CHAT.API.pages[e].pageServices.length;n++)t[CHAT.API.pages[e].pageServices[n]]=CHAT.API.servicesList[CHAT.API.pages[e].pageServices[n]]();return t}},n=0;n<CHAT.API.pages.length;n++)if(CHAT.API.pages[n].pageInfo.name==e){var r=n;t.loadTemplate(n).then(function(e){t.renderTemplate(e),CHAT.API.pages[r].pageFn(t.concatService(r))},function(e){console.error(e)})}},initApp:function(e){var t=e;t().navigate(),t().add(/about/,function(){console.log("about"),CHAT.API.initPage("about-Page")}).add(/login/,function(){CHAT.API.initPage("login-Page")}).add(/registration/,function(){CHAT.API.initPage("registration-Page")}).add(/chat/,function(){CHAT.API.initPage("chat-Page")}).add(/home/,function(){CHAT.API.initPage("home-Page")}).add(/hui/,function(){CHAT.API.initPage("home-Page")}).listen(),t().navigate("/home/")}}};CHAT.servicesFunctionality.services=function(e,t){var n=e,r=t;CHAT.API.servicesList[n]=r},CHAT.servicesFunctionality.pages=function(e,t,n){var r=e,i=n,a=t;CHAT.API.pages.push({pageInfo:r,pageFn:i,pageServices:a})},setTimeout(innit,3e3),CHAT.servicesFunctionality.services("storage",function(){return console.info("Start work storage"),{push:function(e,t){try{localStorage.setItem(e,t)}catch(n){n==QUOTA_EXCEEDED_ERR&&console.log("Локальное хранилище переполнено")}},get:function(e){localStorage.getItem(e)},clear:function(e){localStorage.removeItem(e)},clearAll:function(){localStorage.clear(),console.log("clear all storage")}}}),CHAT.servicesFunctionality.services("mediator",function(){console.info("Start work mediator");var e=function(e,t){return mediator.channels[e]||(mediator.channels[e]=[]),mediator.channels[e].push({context:this,callback:t}),this},t=function(e){if(!mediator.channels[e])return!1;for(var t=Array.prototype.slice.call(arguments,1),n=0,r=mediator.channels[e].length;r>n;n++){var i=mediator.channels[e][n];i.callback.apply(i.context,t)}return this};return{channels:{},publish:t,listen:e,installTo:function(n){n.listen=e,n.publish=t}}}),CHAT.servicesFunctionality.services("urlData",function(){function e(){return location}function t(){var e=new Object,t=location.search?location.search.slice(1).split("&"):void 0,n=function(t){return void 0==t?!1:void t.forEach(function(t,n,r){return r.length<1?!1:void(e[t.split("=")[0]]=t.split("=")[1])})};return n(t),e}return{allData:e(),search:t()}}),CHAT.servicesFunctionality.services("router",function(){return console.info("router init"),{routes:[],mode:"history",root:"/",config:function(e){return this.mode=e&&e.mode&&"history"==e.mode&&history.pushState?"history":"hash",this.root=e&&e.root?"/"+this.clearSlashes(e.root)+"/":"/",this},getFragment:function(){var e="";if("history"===this.mode)e=this.clearSlashes(decodeURI(location.pathname+location.search)),e=e.replace(/\?(.*)$/,""),e="/"!=this.root?e.replace(this.root,""):e;else{var t=window.location.href.match(/#(.*)$/);e=t?t[1]:""}return this.clearSlashes(e)},clearSlashes:function(e){return e.toString().replace(/\/$/,"").replace(/^\//,"")},add:function(e,t){return"function"==typeof e&&(t=e,e=""),this.routes.push({re:e,handler:t}),this},remove:function(e){for(var t,n=0;n<this.routes.length,t=this.routes[n];n++)if(t.handler===e||t.re.toString()===e.toString())return this.routes.splice(n,1),this;return this},flush:function(){return this.routes=[],this.mode=null,this.root="/",this},check:function(e){for(var t=e||this.getFragment(),n=0;n<this.routes.length;n++){var r=t.match(this.routes[n].re);if(r)return r.shift(),this.routes[n].handler.apply({},r),this}return this},listen:function(){var e=this,t=e.getFragment(),n=function(){t!==e.getFragment()&&(t=e.getFragment(),e.check(t))};return clearInterval(this.interval),this.interval=setInterval(n,50),this},navigate:function(e){return e=e?e:"","history"===this.mode?history.pushState(null,null,this.root+this.clearSlashes(e)):(window.location.href.match(/#(.*)$/),window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+e),this},linkSettings:function(){for(var e=this,t=document.getElementsByTagName("a"),n=0;n<t.length;n++)t[n].addEventListener("click",function(t){t.preventDefault(),e.navigate(this.href.split("ttp://localhost:3000")[1])},!0)}}}),CHAT.servicesFunctionality.services("mySort",function(){Array.prototype.syperSort=function(){for(var e=[1],t=this,n=0;n<t.length;n++)for(var r=0;r<e.length;r++)e[r]<t[n]&&e.splice(r+1,0,t[n]);console.log(e,"asdasdasd")};var e=[2,1,4,3,8,7,9,0,5];e.syperSort()}),CHAT.servicesFunctionality.services("httpAjax",function(e,t){return{get:function(e){return new Promise(function(t,n){var r=new XMLHttpRequest;r.open("GET",e,!0),r.onload=function(){if(200==this.status)t(this.response);else{var e=new Error(this.statusText);e.code=this.status,n(e)}},r.onerror=function(){n(new Error("Network Error"))},r.send()})},post:function(e,t){return new Promise(function(n,r){var i=new XMLHttpRequest;i.open("POST",e,!0),i.onload=function(){if(200==this.status)n(this.response);else{var e=new Error(this.statusText);e.code=this.status,r(e)}},i.onerror=function(){r(new Error("Network Error"))},i.send(t)})}}}),CHAT.servicesFunctionality.pages({name:"about-Page",template:"/template/about-Page.html"},["storage"],function(e){alert("about")}),CHAT.servicesFunctionality.pages({name:"chat-Page",template:"/template/chat-Page.html"},["storage","urlData","httpAjax"],function(e){var t={urlSearch:e.urlData.search},n={checkChatRoom:function(){return void 0!=t.urlSearch.roomName?{roomName:t.urlSearch.roomName}:"baseRoom"}};!function r(){var e=new XMLHttpRequest;e.open("POST","/api/subscribe",!0),e.onreadystatechange=function(){if(4==this.readyState){if(200!=this.status)return void setTimeout(r,500);var e=document.createElement("li");e.appendChild(document.createTextNode(this.responseText)),messages.appendChild(e),r()}},e.send(JSON.stringify(n.checkChatRoom()))}(),publish.onsubmit=function(){var e=new XMLHttpRequest,t={message:this.elements.messages.value,roomName:n.checkChatRoom().roomName};return e.open("POST","/api/publish",!0),e.send(JSON.stringify(t)),this.elements.messages.value="",!1},rooms.onsubmit=function(){var e=new XMLHttpRequest;return e.open("PUT","/api/room-create",!0),e.send(JSON.stringify({name:this.elements.name.value,id:this.elements.id.value})),this.elements.name.value="",this.elements.id.value="",!1}}),CHAT.servicesFunctionality.pages({name:"home-Page",template:"/template/homePage/home-Page.html"},["storage","mediator","httpAjax"],function(e){var t=document.getElementById("home-Page"),n=e.httpAjax.get("/api/getAllRooms");n.then(function(e){var t=JSON.parse(e);return Promise.all(t)},function(e){console.error(e)}).then(function(n){var r=e.httpAjax.get("/template/homePage/microTemplate/home-Page_micro-Room-block.html");r.then(function(e){for(var r="",i=0;i<n.length;i++)r+=tmpl(e,n[i]);t.innerHTML=r,CHAT.API.servicesList.router().linkSettings()},function(e){console.error(e)})})}),CHAT.servicesFunctionality.pages({name:"login-Page",template:"/template/login-Page.html"},["storage"],function(e){login.onsubmit=function(){var e=new XMLHttpRequest;return e.open("POST","/api/authorize",!0),e.send(JSON.stringify({name:this.elements.name.value,password:this.elements.password.value})),this.elements.name.value="",this.elements.password.value="",!1}}),CHAT.servicesFunctionality.pages({name:"registration-Page",template:"/template/registration-Page.html"},["storage"],function(e){registration.onsubmit=function(){var e=new XMLHttpRequest;return e.open("POST","/api/registration",!0),e.send(JSON.stringify({name:this.elements.name.value,password:this.elements.password.value})),this.elements.name.value="",this.elements.password.value="",!1}});