"use strict";function innit(){!function(){var e={};window.tmpl=function t(n,a){var o=/\W/.test(n)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+n.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):e[n]=e[n]||t(document.getElementById(n).innerHTML);return a?o(a):o}}(),CHAT.API.initApp(CHAT.API.servicesList.router)}var CHAT={servicesFunctionality:{},constant:{titleNode:document.getElementById("page-title")},baseServices:{changeTitle:function(e){console.log(CHAT.constant,"==="),CHAT.constant.titleNode.innerHTML=e}},API:{servicesList:{},pages:[],cashTemplates:{},initPage:function(e){for(var t={loadTemplate:function(e){var t=CHAT.API.cashTemplates[CHAT.API.pages[e].pageInfo.name.replace("-","_")];if(!t){var n=CHAT.API.servicesList.httpAjax().get(CHAT.API.pages[e].pageInfo.template,"GET");return CHAT.API.cashTemplates[CHAT.API.pages[e].pageInfo.name.replace("-","_")]=n,n}return t},renderTemplate:function(e){var t=document.createElement("div");t.innerHTML=e,document.getElementById("body").innerHTML="",document.getElementById("body").appendChild(t),CHAT.API.servicesList.router().linkSettings()},concatService:function(e){for(var t={},n=0;n<CHAT.API.pages[e].pageServices.length;n++)t[CHAT.API.pages[e].pageServices[n]]=CHAT.API.servicesList[CHAT.API.pages[e].pageServices[n]]();return t}},n=0;n<CHAT.API.pages.length;n++)if(CHAT.API.pages[n].pageInfo.name==e){var a=n;t.loadTemplate(n).then(function(e){t.renderTemplate(e),CHAT.API.pages[a].pageFn(t.concatService(a))},function(e){console.error(e)}),CHAT.baseServices.changeTitle(CHAT.API.pages[a].pageInfo.pageTitle)}},initApp:function(e){var t=e,n=CHAT.API.servicesList.httpAjax().get("/api/saveUrl");n.then(function(e){e.length?t().navigate(e+"/"):(CHAT.API.initPage("home-Page"),t().navigate("/home.do/"))},function(e){console.error(e)}),t().navigate(),t().add(/about.do/,function(){console.log("about"),CHAT.API.initPage("about-Page")}).add(/login.do/,function(){CHAT.API.initPage("login-Page")}).add(/registration.do/,function(){CHAT.API.initPage("registration-Page")}).add(/chat.do/,function(){CHAT.API.initPage("chat-Page")}).add(/home.do/,function(){CHAT.API.initPage("home-Page")}).listen(),t().navigate("/home.do/")}}};CHAT.servicesFunctionality.services=function(e,t){var n=e,a=t;CHAT.API.servicesList[n]=a},CHAT.servicesFunctionality.pages=function(e,t,n){var a=e,o=n,r=t;CHAT.API.pages.push({pageInfo:a,pageFn:o,pageServices:r})},setTimeout(innit,3e3),CHAT.servicesFunctionality.services("storage",function(){return console.info("Start work storage"),{push:function(e,t){try{localStorage.setItem(e,t)}catch(n){n==QUOTA_EXCEEDED_ERR&&console.log("Локальное хранилище переполнено")}},get:function(e){return JSON.parse(localStorage.getItem(e))},clear:function(e){localStorage.removeItem(e)},clearAll:function(){localStorage.clear(),console.log("clear all storage")}}}),CHAT.servicesFunctionality.services("mediator",function(){console.info("Start work mediator");var e=function(e,t){return mediator.channels[e]||(mediator.channels[e]=[]),mediator.channels[e].push({context:this,callback:t}),this},t=function(e){if(!mediator.channels[e])return!1;for(var t=Array.prototype.slice.call(arguments,1),n=0,a=mediator.channels[e].length;a>n;n++){var o=mediator.channels[e][n];o.callback.apply(o.context,t)}return this};return{channels:{},publish:t,listen:e,installTo:function(n){n.listen=e,n.publish=t}}}),CHAT.servicesFunctionality.services("urlData",function(){function e(){return location}function t(){var e=new Object,t=location.search?location.search.slice(1).split("&"):void 0,n=function(t){return void 0==t?!1:void t.forEach(function(t,n,a){return a.length<1?!1:void(e[t.split("=")[0]]=t.split("=")[1])})};return n(t),e}return{allData:e(),search:t()}}),CHAT.servicesFunctionality.services("router",function(){return console.info("router init"),{routes:[],mode:"history",root:"/",config:function(e){return this.mode=e&&e.mode&&"history"==e.mode&&history.pushState?"history":"hash",this.root=e&&e.root?"/"+this.clearSlashes(e.root)+"/":"/",this},getFragment:function(){var e="";if("history"===this.mode)e=this.clearSlashes(decodeURI(location.pathname+location.search)),e=e.replace(/\?(.*)$/,""),e="/"!=this.root?e.replace(this.root,""):e;else{var t=window.location.href.match(/#(.*)$/);e=t?t[1]:""}return this.clearSlashes(e)},clearSlashes:function(e){return e.toString().replace(/\/$/,"").replace(/^\//,"")},add:function(e,t){return"function"==typeof e&&(t=e,e=""),this.routes.push({re:e,handler:t}),this},remove:function(e){for(var t,n=0;n<this.routes.length,t=this.routes[n];n++)if(t.handler===e||t.re.toString()===e.toString())return this.routes.splice(n,1),this;return this},flush:function(){return this.routes=[],this.mode=null,this.root="/",this},check:function(e){for(var t=e||this.getFragment(),n=0;n<this.routes.length;n++){var a=t.match(this.routes[n].re);if(a)return a.shift(),this.routes[n].handler.apply({},a),this}return this},listen:function(){var e=this,t=e.getFragment(),n=function(){t!==e.getFragment()&&(t=e.getFragment(),e.check(t))};return clearInterval(this.interval),this.interval=setInterval(n,50),this},navigate:function(e){return e=e?e:"","history"===this.mode?history.pushState(null,null,this.root+this.clearSlashes(e)):(window.location.href.match(/#(.*)$/),window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+e),this},linkSettings:function(){for(var e=this,t=document.getElementsByTagName("a"),n=0;n<t.length;n++)t[n].addEventListener("click",function(t){t.preventDefault(),e.navigate(this.href.split("ttp://localhost:3000")[1])},!0)}}}),CHAT.servicesFunctionality.services("mySort",function(){Array.prototype.syperSort=function(){for(var e=[1],t=this,n=0;n<t.length;n++)for(var a=0;a<e.length;a++)e[a]<t[n]&&e.splice(a+1,0,t[n]);console.log(e,"asdasdasd")};var e=[2,1,4,3,8,7,9,0,5];e.syperSort()}),CHAT.servicesFunctionality.services("httpAjax",function(e,t){return{get:function(e){return new Promise(function(t,n){var a=new XMLHttpRequest;a.open("GET",e,!0),a.onload=function(){if(200==this.status)t(this.response);else{var e=new Error(this.statusText);e.code=this.status,n(e)}},a.onerror=function(){n(new Error("Network Error"))},a.send()})},post:function(e,t){return new Promise(function(n,a){var o=new XMLHttpRequest;o.open("POST",e,!0),o.onload=function(){if(200==this.status)n(this.response);else{var e=new Error(this.statusText);e.code=this.status,a(e)}},o.onerror=function(){a(new Error("Network Error"))},o.send(t)})}}}),CHAT.servicesFunctionality.pages({name:"about-Page",template:"/template/about-Page.html"},["storage"],function(e){alert("about")}),CHAT.servicesFunctionality.pages({name:"chat-Page",pageTitle:"Чат, главная комната",template:"/template/chatPage/chat-Page.html"},["storage","urlData","httpAjax"],function(e){var t={urlSearch:e.urlData.search,userName:e.storage.get("userInfo"),chatMessHtml:e.httpAjax.get("/template/chatPage/microTemplate/chatMessage.html").then(function(e){t.chatMessHtml=e},function(e){console.err(e)})},n={checkChatRoom:function(){return void 0!=t.urlSearch.roomName?{roomName:t.urlSearch.roomName}:{roomName:"baseRoom"}},changeTitle:function(e){"baseRoom"!==e.roomName&&CHAT.baseServices.changeTitle("Чат - "+e.roomName)}};n.changeTitle(n.checkChatRoom()),function a(){var e=new XMLHttpRequest;e.open("POST","/api/subscribe",!0),e.onreadystatechange=function(){if(4==this.readyState){if(200!=this.status)return void setTimeout(a,500);var e=document.createElement("li"),n=tmpl(t.chatMessHtml,JSON.parse(this.responseText));e.innerHTML=n,messages.appendChild(e),a()}},e.send(JSON.stringify(n.checkChatRoom()))}(),publish.onsubmit=function(){var e=new XMLHttpRequest,a={userName:t.userName.username,message:this.elements.messages.value,roomName:n.checkChatRoom().roomName};return e.open("POST","/api/publish",!0),e.send(JSON.stringify(a)),this.elements.messages.value="",!1},rooms.onsubmit=function(){var e=new XMLHttpRequest;return e.open("PUT","/api/room-create",!0),e.send(JSON.stringify({name:this.elements.name.value,id:this.elements.id.value})),this.elements.name.value="",this.elements.id.value="",!1}}),CHAT.servicesFunctionality.pages({name:"home-Page",pageTitle:"Главная",template:"/template/homePage/home-Page.html"},["storage","mediator","httpAjax"],function(e){var t=document.getElementById("home-Page"),n=e.httpAjax.get("/api/getAllRooms");n.then(function(e){var t=JSON.parse(e);return Promise.all(t)},function(e){console.error(e)}).then(function(n){var a=e.httpAjax.get("/template/homePage/microTemplate/home-Page_micro-Room-block.html");a.then(function(e){for(var a="",o=0;o<n.length;o++)a+=tmpl(e,n[o]);t.innerHTML=a,CHAT.API.servicesList.router().linkSettings()},function(e){console.error(e)})})}),CHAT.servicesFunctionality.pages({name:"login-Page",pageTitle:"Авторизация",template:"/template/login-Page.html"},["storage","httpAjax"],function(e){login.onsubmit=function(t){t.preventDefault();var n=e.httpAjax.post("/api/authorize",JSON.stringify({name:this.elements.name.value,password:this.elements.password.value}));n.then(function(t){e.storage.push("userInfo",t)},function(e){console.error(e)})}}),CHAT.servicesFunctionality.pages({name:"registration-Page",pageTitle:"Регистрация",template:"/template/registration-Page.html"},["storage"],function(e){registration.onsubmit=function(){var e=new XMLHttpRequest;return e.open("POST","/api/registration",!0),e.send(JSON.stringify({name:this.elements.name.value,password:this.elements.password.value})),this.elements.name.value="",this.elements.password.value="",!1}});