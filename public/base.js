"use strict";function innit(){CHAT.API.initApp(CHAT.API.servicesList.router)}var CHAT={servicesFunctionality:{},root:{},API:{servicesList:{},pages:[],initPage:function(e){for(var t={loadTemplate:function(e){return CHAT.API.servicesList.httpAjax().get(CHAT.API.pages[e].pageInfo.template)},renderTemplate:function(e){var t=document.createElement("div");t.innerHTML=e,document.getElementById("body").innerHTML="",document.getElementById("body").appendChild(t)}},n=0;n<CHAT.API.pages.length;n++)CHAT.API.pages[n].pageInfo.name==e&&t.loadTemplate(n).then(function(e){t.renderTemplate(e),console.log(CHAT.API.pages[n],n),CHAT.API.pages[n-1].pageFn(CHAT.API.servicesList[CHAT.API.pages[n-1].pageServices]())},function(e){console.error(e)})},initApp:function(e){var t=e;t().config({mode:"history"}),t().navigate(),t().add(/about/,function(){console.log("about"),CHAT.API.initPage("about-Page")}).add(/chat/,function(){console.log("chat"),CHAT.API.initPage("home-Page")}).add(/login/,function(){CHAT.API.initPage("login-Page")}).add(/registration/,function(){CHAT.API.initPage("registration-Page")}).listen(),t().navigate("/");for(var n=document.getElementsByTagName("a"),s=0;s<n.length;s++)n[s].addEventListener("click",function(e){e.preventDefault(),t().navigate(e.srcElement.pathname)})}}};CHAT.servicesFunctionality.services=function(e,t){var n=e,s=t;CHAT.API.servicesList[n]=s},CHAT.servicesFunctionality.pages=function(e,t,n){var s=e,i=n,a=t;CHAT.API.pages.push({pageInfo:s,pageFn:i,pageServices:a})},setTimeout(innit,3e3),CHAT.servicesFunctionality.services("storage",function(){return{push:function(e,t){try{localStorage.setItem(e,t)}catch(n){n==QUOTA_EXCEEDED_ERR&&console.log("Локальное хранилище переполнено")}},get:function(e){localStorage.getItem(e)},clear:function(e){localStorage.removeItem(e)},clearAll:function(){localStorage.clear(),console.log("clear all storage")}}}),CHAT.servicesFunctionality.services("mediator",function(){var e=function(e,t){return mediator.channels[e]||(mediator.channels[e]=[]),mediator.channels[e].push({context:this,callback:t}),this},t=function(e){if(!mediator.channels[e])return!1;for(var t=Array.prototype.slice.call(arguments,1),n=0,s=mediator.channels[e].length;s>n;n++){var i=mediator.channels[e][n];i.callback.apply(i.context,t)}return this};return{channels:{},publish:t,listen:e,installTo:function(n){n.listen=e,n.publish=t}}}),CHAT.servicesFunctionality.services("router",function(){return console.info("router init"),{routes:[],mode:null,root:"/",config:function(e){return this.mode=e&&e.mode&&"history"==e.mode&&history.pushState?"history":"hash",this.root=e&&e.root?"/"+this.clearSlashes(e.root)+"/":"/",this},getFragment:function(){var e="";if("history"===this.mode)e=this.clearSlashes(decodeURI(location.pathname+location.search)),e=e.replace(/\?(.*)$/,""),e="/"!=this.root?e.replace(this.root,""):e;else{var t=window.location.href.match(/#(.*)$/);e=t?t[1]:""}return this.clearSlashes(e)},clearSlashes:function(e){return e.toString().replace(/\/$/,"").replace(/^\//,"")},add:function(e,t){return"function"==typeof e&&(t=e,e=""),this.routes.push({re:e,handler:t}),this},remove:function(e){for(var t,n=0;n<this.routes.length,t=this.routes[n];n++)if(t.handler===e||t.re.toString()===e.toString())return this.routes.splice(n,1),this;return this},flush:function(){return this.routes=[],this.mode=null,this.root="/",this},check:function(e){for(var t=e||this.getFragment(),n=0;n<this.routes.length;n++){var s=t.match(this.routes[n].re);if(s)return s.shift(),this.routes[n].handler.apply({},s),this}return this},listen:function(){var e=this,t=e.getFragment(),n=function(){t!==e.getFragment()&&(t=e.getFragment(),e.check(t))};return clearInterval(this.interval),this.interval=setInterval(n,50),this},navigate:function(e){return e=e?e:"","history"===this.mode?history.pushState(null,null,this.root+this.clearSlashes(e)):(window.location.href.match(/#(.*)$/),window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+e),this}}}),CHAT.servicesFunctionality.services("mySort",function(){Array.prototype.syperSort=function(){for(var e=[1],t=this,n=0;n<t.length;n++)for(var s=0;s<e.length;s++)e[s]<t[n]&&e.splice(s+1,0,t[n]);console.log(e,"asdasdasd")};var e=[2,1,4,3,8,7,9,0,5];e.syperSort()}),CHAT.servicesFunctionality.services("httpAjax",function(e,t){new XMLHttpRequest;return{get:function(e){return new Promise(function(t,n){var s=new XMLHttpRequest;s.open("GET",e,!0),s.onload=function(){if(200==this.status)t(this.response);else{var e=new Error(this.statusText);e.code=this.status,n(e)}},s.onerror=function(){n(new Error("Network Error"))},s.send()})}}}),CHAT.servicesFunctionality.pages({name:"about-Page",template:"/template/about-Page.html"},["storage"],function(e){alert("about")}),CHAT.servicesFunctionality.pages({name:"home-Page",template:"/template/home-Page.html"},["storage"],function(e){alert("home"),rooms.onsubmit=function(){var e=new XMLHttpRequest;return e.open("PUT","/api/room-create",!0),e.send(JSON.stringify({name:this.elements.name.value,id:this.elements.id.value})),this.elements.name.value="",this.elements.id.value="",!1},login.onsubmit=function(){var e=new XMLHttpRequest;return e.open("POST","/api/authorize",!0),e.send(JSON.stringify({name:this.elements.name.value,password:this.elements.password.value})),this.elements.name.value="",this.elements.password.value="",!1},roomsTheme.onsubmit=function(){var e=new XMLHttpRequest;return e.open("PUT","/api/room-update-theme",!0),e.send(JSON.stringify({name:this.elements.name.value,id:this.elements.id.value})),this.elements.name.value="",this.elements.id.value="",!1},function t(){var e=new XMLHttpRequest;e.open("GET","/api/subscribe",!0),e.onreadystatechange=function(){if(4==this.readyState){if(200!=this.status)return void setTimeout(t,500);var e=document.createElement("li");e.appendChild(document.createTextNode(this.responseText)),messages.appendChild(e),t()}},e.send(null)}(),publish.onsubmit=function(){var e=new XMLHttpRequest;return e.open("POST","/api/publish",!0),e.send(JSON.stringify({message:this.elements.message.value})),this.elements.message.value="",!1},e.clear()}),CHAT.servicesFunctionality.pages({name:"login-Page",template:"/template/login-Page.html"},["storage"],function(e){login.onsubmit=function(){var e=new XMLHttpRequest;return e.open("POST","/api/authorize",!0),e.send(JSON.stringify({name:this.elements.name.value,password:this.elements.password.value})),this.elements.name.value="",this.elements.password.value="",!1}}),CHAT.servicesFunctionality.pages({name:"registration-Page",template:"/template/registration-Page.html"},["storage"],function(e){registration.onsubmit=function(){var e=new XMLHttpRequest;return e.open("POST","/api/registration",!0),e.send(JSON.stringify({name:this.elements.name.value,password:this.elements.password.value})),this.elements.name.value="",this.elements.password.value="",!1}});